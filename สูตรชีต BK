// @ts-nocheck
/**
 * =================================================================
 * ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏±‡πà‡∏ô (‡∏•‡∏π‡∏Å‡∏û‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ‚úÖ
 * =================================================================
 */
const SEPARATOR_CONFIG = {
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏±‡πà‡∏ô‡∏¢‡∏≤‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏´‡∏ô‡∏ñ‡∏∂‡∏á‡πÑ‡∏´‡∏ô (A=1, B=2, ..., R=18)
  columnStart: 1,  // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A
  columnEnd: 18,   // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå R

  // --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏±‡πà‡∏ô "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" ---
  monthSeparator: {
    enabled: true,
    textPrefix: '--- ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ',
    textSuffix: ' ---',
    backgroundColor: '#4682B4', // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (SteelBlue)
    fontColor: '#FFFFFF',
    fontWeight: 'bold',
    fontSize: 12,
    addExtraBlankRow: true // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á "‡∏Å‡πà‡∏≠‡∏ô" ‡πÅ‡∏•‡∏∞ "‡∏´‡∏•‡∏±‡∏á" ‡πÅ‡∏ñ‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  },

  // --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏±‡πà‡∏ô "‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô" ---
  daySeparator: {
    enabled: true,
    backgroundColor: '#F0F8FF' // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏±‡πà‡∏ô‡∏ß‡∏±‡∏ô (AliceBlue)
  }
};


/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏•‡∏∞ Dropdown)
 */
function updateDateAndNoColumnsOnly() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getActiveSheet();
  const sheetName = sheet.getName();

  const rowsPerDay = 30;
  const ui = SpreadsheetApp.getUi();

  const headerCheck = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  if (headerCheck.indexOf("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà") === -1 || headerCheck.indexOf("No.") === -1) {
    Browser.msgBox(`‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" ‡∏´‡∏£‡∏∑‡∏≠ "No." ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï "${sheetName}" ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢`);
    return;
  }

  // --- ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö Input ‡∏à‡∏≤‡∏Å User (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£) ---
  let startDateInput = ui.prompt('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÄ‡∏ä‡πà‡∏ô 1/7/2025):\n* Script ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡πÜ ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', ui.ButtonSet.OK_CANCEL);
  if (startDateInput.getSelectedButton() === ui.Button.CANCEL) return;
  let startDateDisplayStr = startDateInput.getResponseText();

  let numDaysToCreateInput = ui.prompt('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πà‡∏ô 90 ‡∏ß‡∏±‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô):', ui.ButtonSet.OK_CANCEL);
  if (numDaysToCreateInput.getSelectedButton() === ui.Button.CANCEL) return;
  let numDaysToCreate = parseInt(numDaysToCreateInput.getResponseText(), 10);

  let startRowInput = ui.prompt('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ä‡πà‡∏ô 2 ‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á):\n*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A ‡πÅ‡∏•‡∏∞ B ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö', ui.ButtonSet.OK_CANCEL);
  if (startRowInput.getSelectedButton() === ui.Button.CANCEL) return;
  let startRowToWrite = parseInt(startRowInput.getResponseText(), 10);

  if (isNaN(numDaysToCreate) || numDaysToCreate <= 0 || isNaN(startRowToWrite) || startRowToWrite < 1) {
    Browser.msgBox("Error: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÅ‡∏ñ‡∏ß.");
    return;
  }
  if (startRowToWrite === 1) {
    const confirmOverwriteHeader = ui.alert('‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡πâ‡∏≤‡∏¢‡πÅ‡∏£‡∏á!', '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', ui.ButtonSet.YES_NO);
    if (confirmOverwriteHeader === ui.Button.NO) {
      Browser.msgBox("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      return;
    }
  }

  function parseDateForCalculation(dateString) {
    const parts = dateString.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if (!parts) return null;
    let day = parseInt(parts[1], 10);
    let month = parseInt(parts[2], 10);
    let year = parseInt(parts[3], 10);
    if (year < 100) {
      year += (year < 50 ? 2000 : 1900);
    }
    return new Date(year, month - 1, day);
  }

  let currentCalcDate = parseDateForCalculation(startDateDisplayStr);
  if (!currentCalcDate || isNaN(currentCalcDate.getTime())) {
    Browser.msgBox("Error: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô.");
    return;
  }
  currentCalcDate.setHours(0, 0, 0, 0);

  const headerRowValues = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const dateColIdx = headerRowValues.indexOf("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
  const noColIdx = headerRowValues.indexOf("No.");
  const estimatedTotalWidth = headerRowValues.length > 0 ? headerRowValues.length : 18; // Fallback to 18 (R)

  if (dateColIdx === -1 || noColIdx === -1) {
    Browser.msgBox("Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà' ‡∏´‡∏£‡∏∑‡∏≠ 'No.' ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
    return;
  }

  // ‚ú® --- NEW: ‡∏™‡∏£‡πâ‡∏≤‡∏á Array ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß --- ‚ú®
  const dataToWrite = [];
  const backgroundsToWrite = [];
  const mergesToPerform = [];
  const fontStylesToPerform = [];
  
  // ‚ú®‚úÖ FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‚úÖ‚ú®
  const monthDropdownOptions = ['--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ---'];
  const monthRowMap = {};

  const monthNamesTh = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  let previousMonth = currentCalcDate.getMonth();
  let currentRowCounter = startRowToWrite;

  for (let d = 0; d < numDaysToCreate; d++) {
    let tempDate = new Date(currentCalcDate);
    tempDate.setDate(currentCalcDate.getDate() + d);

    if (d === 0 || tempDate.getMonth() !== previousMonth) {
      if (SEPARATOR_CONFIG.monthSeparator.enabled) {
        if (SEPARATOR_CONFIG.monthSeparator.addExtraBlankRow && d > 0) { // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î
          dataToWrite.push(new Array(estimatedTotalWidth).fill(''));
          backgroundsToWrite.push(new Array(estimatedTotalWidth).fill(null));
          currentRowCounter++;
        }
        
        const monthText = `${SEPARATOR_CONFIG.monthSeparator.textPrefix}${monthNamesTh[tempDate.getMonth()]} ${tempDate.getFullYear() + 543}${SEPARATOR_CONFIG.monthSeparator.textSuffix}`;
        const monthRow = new Array(estimatedTotalWidth).fill('');
        monthRow[0] = monthText;
        dataToWrite.push(monthRow);
        backgroundsToWrite.push(new Array(estimatedTotalWidth).fill(SEPARATOR_CONFIG.monthSeparator.backgroundColor));
        mergesToPerform.push(`A${currentRowCounter}:R${currentRowCounter}`);
        fontStylesToPerform.push({ range: `A${currentRowCounter}`, color: SEPARATOR_CONFIG.monthSeparator.fontColor, weight: SEPARATOR_CONFIG.monthSeparator.fontWeight, size: SEPARATOR_CONFIG.monthSeparator.fontSize, align: 'center'});
        
        // ‚ú®‚úÖ FIX: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏á‡πÉ‡∏ô Array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown ‚úÖ‚ú®
        monthDropdownOptions.push(monthText);
        monthRowMap[monthText] = currentRowCounter;
        
        currentRowCounter++;
        
        if (SEPARATOR_CONFIG.monthSeparator.addExtraBlankRow) {
          dataToWrite.push(new Array(estimatedTotalWidth).fill(''));
          backgroundsToWrite.push(new Array(estimatedTotalWidth).fill(null));
          currentRowCounter++;
        }
      }
    }
    previousMonth = tempDate.getMonth();
    
    let displayDate = `${tempDate.getDate()}/${tempDate.getMonth() + 1}/${tempDate.getFullYear()}`;
    for (let i = 0; i < rowsPerDay; i++) {
        const newRow = new Array(estimatedTotalWidth).fill('');
        newRow[dateColIdx] = displayDate;
        newRow[noColIdx] = i + 1;
        dataToWrite.push(newRow);
        backgroundsToWrite.push(new Array(estimatedTotalWidth).fill(null));
        currentRowCounter++;
    }

    if (d < numDaysToCreate - 1 && SEPARATOR_CONFIG.daySeparator.enabled) {
        dataToWrite.push(new Array(estimatedTotalWidth).fill(''));
        backgroundsToWrite.push(new Array(estimatedTotalWidth).fill(SEPARATOR_CONFIG.daySeparator.backgroundColor));
        mergesToPerform.push(`A${currentRowCounter}:R${currentRowCounter}`);
        currentRowCounter++;
    }
  }

  // ‚ú® --- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ --- ‚ú®
  if (dataToWrite.length > 0) {
    const targetRange = sheet.getRange(startRowToWrite, 1, dataToWrite.length, estimatedTotalWidth);
    targetRange.setValues(dataToWrite);
    targetRange.setBackgrounds(backgroundsToWrite);
    
    for (const mergeRange of mergesToPerform) {
      sheet.getRange(mergeRange).merge();
    }
    
    for (const style of fontStylesToPerform) {
        sheet.getRange(style.range)
            .setFontColor(style.color)
            .setFontWeight(style.weight)
            .setFontSize(style.size)
            .setHorizontalAlignment(style.align);
    }
  }

  // ‚ú®‚úÖ FIX: ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏ñ‡∏ß ‚úÖ‚ú®
  const dropdownCell = sheet.getRange("N1");
  dropdownCell.clearContent();
  dropdownCell.clearDataValidations();
  const rule = SpreadsheetApp.newDataValidation().requireValueInList(monthDropdownOptions, true).build();
  dropdownCell.setDataValidation(rule);
  dropdownCell.setValue(monthDropdownOptions[0]); // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  
  const userProperties = PropertiesService.getUserProperties();
  userProperties.setProperty('monthRowPositions', JSON.stringify(monthRowMap));


  Browser.msgBox(`üéâ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï "${sheetName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
}


// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô onEdit() ‡πÅ‡∏•‡∏∞ goToMonthRow() (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
function onEdit(e) {
  const range = e.range;
  if (range.getA1Notation() === "N1") {
    const selectedMonthText = range.getValue();
    goToMonthRow(selectedMonthText);
  }
}

function goToMonthRow(monthText) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const userProperties = PropertiesService.getUserProperties();
  const monthRowMapString = userProperties.getProperty('monthRowPositions');
  
  if (monthRowMapString) {
      const monthRowPositions = JSON.parse(monthRowMapString);
      if (monthRowPositions && monthRowPositions[monthText]) {
          const targetRow = monthRowPositions[monthText];
          sheet.setActiveRange(sheet.getRange(targetRow, 1));
      }
  }
}

//================================================================================
// ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π
//================================================================================
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  const menu = ui.createMenu('üí•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ RCPüí•');

  // --- (‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏û‡∏µ‡πà) ---
  menu.addItem('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πàüìÖ (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á)', 'updateDateAndNoColumnsOnly');
  menu.addSeparator();
  menu.addItem('Set Project & Setup FB/IG', 'promptProjectName');
  menu.addItem('Apply Project Template', 'applyProjectTemplate');
  menu.addItem('‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå', 'showProjectPrompt');
  menu.addSeparator();
  menu.addSubMenu(ui.createMenu('‚ú® ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå')
    .addItem('‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏é‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'installHighlightRulesOnAllSheets_Hybrid')
    .addItem('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏µ‡∏ï‡∏ô‡∏µ‡πâ (‡∏î‡πà‡∏ß‡∏ô)', 'runHighlightOnCurrentSheetOnly_Simple'));
  menu.addSubMenu(ui.createMenu('üóìÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Monthly Summary')
    .addItem('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', 'generateMonthlyTable'));
  
  // --- ‚úÖ ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ---
  menu.addSubMenu(ui.createMenu('üìÇ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á')
    .addItem('‡∏¢‡∏∏‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ä‡∏µ‡∏ï Transaction)', 'manualCollapseTransaction') 
    .addItem('‡∏¢‡∏∏‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ä‡∏µ‡∏ï Monthly Summary)', 'manualCollapseMonthlySummary')
    .addItem('‡∏¢‡∏∏‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ (‡∏ä‡∏µ‡∏ï Project ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏≠‡∏¢‡∏π‡πà)', 'manualCollapseActiveProjectSheet')
    .addSeparator()
    .addItem('‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π)', 'manualExpandActiveSheet'));
    
  menu.addToUi();
  
}

// ==================================================================
// ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£" (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô Auto)
// ==================================================================
function autoCollapseAll_Triggered() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const todayString = new Date().toLocaleDateString("th-TH");
  const lastRunDate = scriptProperties.getProperty('lastRunDate');

  if (lastRunDate === todayString) {
    Logger.log("Auto-Collapse: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥");
    return; 
  }

  Logger.log("Auto-Collapse: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...");
  
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Logic ‡πÅ‡∏•‡∏∞ "‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì" ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
  const didCollapse = runCollapseLogic_Transaction(); 
  
  // --- [‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ---
  // ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Property ‡∏Å‡πá‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ß‡πà‡∏≤ "‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (didCollapse) {
    scriptProperties.setProperty('lastRunDate', todayString);
    Logger.log("Auto-Collapse: ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß Transaction ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
  } else {
    Logger.log("Auto-Collapse: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß Transaction ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏£‡∏≠‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ");
  }
}

// ==================================================================
// ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡πÄ‡∏°‡∏ô‡∏π" (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô Manual)
// ==================================================================
function manualCollapseTransaction() { runCollapseLogic_Transaction(); }
function manualCollapseMonthlySummary() { runCollapseLogic_MonthlySummary(); }
function manualCollapseActiveProjectSheet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  if (sheet.getName().startsWith("Project")) {
    runCollapseLogic_ByDate(sheet);
  } else {
    SpreadsheetApp.getUi().alert(`‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Project ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`);
  }
}
function manualExpandActiveSheet() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  try { sheet.showRows(1, sheet.getMaxRows()); } catch(e){}
}


// ==================================================================
// ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 4: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå" ‡∏´‡∏£‡∏∑‡∏≠ Logic ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
// ==================================================================

function runCollapseLogic_Transaction() {
  const DAYS_TO_KEEP = 2;
  const SHEET_NAME = "Transaction";
  const LOCK_CELL = "L2";
  const CONFIG_SHEET_NAME = "Config";

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return false; // << ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

  // --- [‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Python ‡∏Å‡πà‡∏≠‡∏ô] ---
  const configSheet = ss.getSheetByName(CONFIG_SHEET_NAME);
  if (configSheet) {
    const status = configSheet.getRange(LOCK_CELL).getDisplayValue();
    if (status === "RUNNING") {
      Logger.log("Transaction: ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Python ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ RUNNING)");
      return false; // << ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    }
  }

  // --- [‡∏î‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏£‡∏¥‡πà‡∏° Logic ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô] ---
  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) return false; // << ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

  const markerValues = sheet.getRange(1, 1, lastRow, 1).getDisplayValues();
  const allDates = new Set();
  let latestDateTimestamp = 0;

  // 2.1 ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  for (let i = 0; i < lastRow; i++) {
    const markerText = markerValues[i][0];
    if (markerText.includes("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")) {
      const match = markerText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
      if (match) {
        const markerDate = new Date(match[3], parseInt(match[2], 10) - 1, match[1], 12);
        const timestamp = markerDate.getTime();
        allDates.add(timestamp);
        if (timestamp > latestDateTimestamp) {
          latestDateTimestamp = timestamp;
        }
      }
    }
  }
  
  if (allDates.size < DAYS_TO_KEEP) {
    Logger.log("‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 2 ‡∏ß‡∏±‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß");
    return false; // << ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  }

  // 2.2 ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ "‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const latestDate = new Date(latestDateTimestamp);
  const latestDateStr = Utilities.formatDate(latestDate, "GMT", "dd/MM/yyyy");
  const endMarkerLatest = "--- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà " + latestDateStr;

  let isLatestBlockComplete = false;
  // ‡∏ß‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏à‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤
  for (let i = lastRow - 1; i >= 0; i--) {
    if (markerValues[i][0] === endMarkerLatest) {
      isLatestBlockComplete = true;
      break;
    }
  }
  
  // 2.3 ‡∏ñ‡πâ‡∏≤‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå" -> ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
  if (!isLatestBlockComplete) {
    Logger.log("‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (" + latestDateStr + ") ‡∏¢‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ö‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î)");
    return false; // << ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  }

  // 3. ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß
  Logger.log("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ("+ latestDateStr +") ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤");
  
  sheet.showRows(1, sheet.getMaxRows());
  SpreadsheetApp.flush();
  
  const sortedDates = Array.from(allDates).sort((a, b) => b - a);
  const datesToKeep = new Set(sortedDates.slice(0, DAYS_TO_KEEP).map(ts => new Date(ts).toLocaleDateString('en-CA')));
  
  let rowsToHide = [];
  let currentBlockStart = -1;
  
  for (let i = 0; i < lastRow; i++) {
    const markerText = markerValues[i][0];
    if (!markerText.includes("---")) continue;
    const match = markerText.match(/(\d{2})\/(\d{2})\/(\d{4})/);
    if (match) {
      const dateStringForCheck = new Date(match[3], parseInt(match[2], 10) - 1, match[1], 12).toLocaleDateString('en-CA');
      if (!datesToKeep.has(dateStringForCheck)) {
        if (markerText.includes("--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô")) {
          currentBlockStart = i + 1;
        }
        if (markerText.includes("--- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î") && currentBlockStart !== -1) {
          rowsToHide.push({ start: currentBlockStart, end: i + 1 });
          currentBlockStart = -1;
        }
      }
    }
  }

  if (rowsToHide.length > 0) {
    Logger.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ã‡πà‡∏≠‡∏ô ${rowsToHide.length} ‡∏ö‡∏•‡πá‡∏≠‡∏Å...`);
    sheet.showRows(1, lastRow); // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
    SpreadsheetApp.flush();
    for (let i = rowsToHide.length - 1; i >= 0; i--) {
      const block = rowsToHide[i];
      sheet.hideRows(block.start, block.end - block.start + 1);
    }
    return true; // <<<< ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ true ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á
  } else {
    Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô");
    return false; // <<<< ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ false ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
  }
}




function runCollapseLogic_MonthlySummary() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Monthly_Summary");
  if (sheet) {
    runCollapseLogic_ByDate(sheet);
  }
}

function runCollapseLogic_AllProjects() {
  const employeeSheetNames = [
    "Project Q", "Project T.", "Project H.", "Project C", "Project Boy", "Project Bow", 
    "Project F", "Project Aorra", "Project N", "Project D", "Project G ‡∏Å‡∏∏‡πä‡∏ö‡∏Å‡∏¥‡πä‡∏ö", 
    "Project King", "Project Carry", "Project Anan", "Project Jes", "Project Admin", "Project ‡πÄ‡∏ó‡∏™"
  ];
  employeeSheetNames.forEach(name => {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(name);
    if (sheet) {
      runCollapseLogic_ByDate(sheet);
    }
  });
}

function runCollapseLogic_ByDate(sheet) {
  if (!sheet) return;
  try { sheet.showRows(1, sheet.getMaxRows()); } catch(e){}
  SpreadsheetApp.flush();
  // („É≠„Ç∏„ÉÉ„ÇØ‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
  const lastRow = sheet.getLastRow();
  const headerRows = 1;
  if (lastRow <= headerRows) return;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  yesterday.setHours(0, 0, 0, 0);
  const values = sheet.getRange(headerRows + 1, 1, lastRow - headerRows, 1).getDisplayValues();
  let firstOldRow = -1, lastOldRow = -1;
  for (let i = 0; i < values.length; i++) {
    const rowDateStr = values[i][0];
    if (!rowDateStr) continue;
    try {
      const parts = rowDateStr.split('/');
      const rowDate = new Date(parts[2], parseInt(parts[1], 10) - 1, parts[0]);
      rowDate.setHours(0, 0, 0, 0);
      if (rowDate < yesterday) {
        if (firstOldRow === -1) firstOldRow = i + headerRows + 1;
        lastOldRow = i + headerRows + 1;
      }
    } catch (e) { continue; }
  }
  if (firstOldRow !== -1) {
    sheet.hideRows(firstOldRow, lastOldRow - firstOldRow + 1);
  }
}






function setupFBIG() {
  const sh = SpreadsheetApp.getActiveSheet();
  if (!sh.getName().startsWith('Project ')) return;
  sh.getRange('E1:F1').clearContent();
  sh.getRange('E1').setFormula(`=ARRAYFORMULA(IF(ROW(E:E)=1,"FB",IF(ROW(E:E)<=3,"",IF(D:D="","",IFERROR(VLOOKUP($O$1,Staffs!$F:$H,2,FALSE),0)))))`);
  sh.getRange('F1').setFormula(`=ARRAYFORMULA(IF(ROW(F:F)=1,"IG",IF(ROW(F:F)<=3,"",IF(D:D="","",IFERROR(VLOOKUP($O$1,Staffs!$F:$H,3,FALSE),0)))))`);
}


function promptProjectName() {
  const ui = SpreadsheetApp.getUi();
  const res = ui.prompt('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏µ‡∏ï Staffs!F:F):', ui.ButtonSet.OK_CANCEL);
  if (res.getSelectedButton() !== ui.Button.OK) return;
  const name = res.getResponseText().trim();
  if (!name) {
    ui.alert('‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á!');
    return;
  }
  const sh = SpreadsheetApp.getActiveSheet();
  sh.getRange('O1').setValue(name);
  setupFBIG();
  ui.alert(`‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô "${name}" ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏™‡∏π‡∏ï‡∏£ FB/IG ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ`);
}

function applyProjectTemplate() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActive();
  const sheet = ss.getActiveSheet();
  const resp = ui.prompt('Project Template', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á = ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏µ‡∏ï):', ui.ButtonSet.OK_CANCEL);
  if (resp.getSelectedButton() != ui.Button.OK) return;
  let lastRow = parseInt(resp.getResponseText(), 10);
  if (isNaN(lastRow) || lastRow <= 0) {
    lastRow = sheet.getMaxRows();
  }
  sheet.getRange('K1').setFormula(`={"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô";ARRAYFORMULA(IF(A2:A="","",IF((G2:G<>"")*(H2:H<>""),"‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö",IF((G2:G<>"")+(H2:H<>"")=1,"‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á 1 ‡∏Ñ‡∏•‡∏¥‡∏õ","‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á 2 ‡∏Ñ‡∏•‡∏¥‡∏õ"))))}`);
  sheet.getRange('P1').setFormula(`={"Clips_Sent";ARRAYFORMULA(IF(A2:A="","",IF(LEN(G2:G)>0,1,0)+IF(LEN(H2:H)>0,1,0)))}`);
  sheet.getRange('Q1').setFormula(`={"Leave_Days";ARRAYFORMULA(IF(A2:A="","",IF(COUNTIFS(A2:A,A2:A,R2:R,"‡∏´‡∏¢‡∏∏‡∏î")>0,"‡∏´‡∏¢‡∏∏‡∏î",IF(R2:R<>"",R2:R,""))))}`);
  const rule = SpreadsheetApp.newDataValidation().requireValueInList(["‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö", "‡∏´‡∏¢‡∏∏‡∏î", "‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á 1 ‡∏Ñ‡∏•‡∏¥‡∏õ", "‡∏Ç‡∏≤‡∏î‡∏™‡πà‡∏á 2 ‡∏Ñ‡∏•‡∏¥‡∏õ"], true).setAllowInvalid(false).build();
  sheet.getRange(2, 18, lastRow - 1, 1).setDataValidation(rule);
  ui.alert('Applied template up to row ' + lastRow);
}


// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏´‡∏•‡∏±‡∏Å
/**
 * Helper function to convert sheet data (2D array) into an array of objects.
 * The first row of the data is used as keys.
 * @param {Array<Array<any>>} data The 2D array from sheet.getValues().
 * @returns {Array<Object>} An array of objects.
 */
function sheetDataToObjects(data) {
  if (data.length < 2) return [];
  const headers = data[0].map(header => header.trim());
  const objects = [];
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const obj = {};
    for (let j = 0; j < headers.length; j++) {
      obj[headers[j]] = row[j];
    }
    objects.push(obj);
  }
  return objects;
}

function getMonthThai(monthIndex) {
  const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  return months[monthIndex];
}


/**
 * @OnlyCurrentDoc
 * Creates a custom menu to generate and manage the Monthly Summary sheet.
 */
/**
 * A helper function that sets up all header formulas on a fresh sheet.
 * @param {Sheet} sheet The sheet object for 'Monthly_Summary'.
 */
function setupHeaderFormulas(sheet) {
  SpreadsheetApp.getActiveSpreadsheet().toast("‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏µ‡∏ï‡πÉ‡∏´‡∏°‡πà, ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏±‡∏á‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...", "‚öôÔ∏è Setup Formulas");

  // Object containing all final, tested formulas
  const formulas = {
    'C1': '={\"Name\"; ARRAYFORMULA(IF(LEN(B2:B), IFERROR(VLOOKUP(B2:B, {Staffs!F:F, Staffs!C:C}, 2, FALSE)), IFERROR(1/0)))}',
    'D1': '={\"Project\"; ARRAYFORMULA(IF(LEN(C2:C), IFERROR(VLOOKUP(C2:C, Staffs!C:F, 4, FALSE)), IFERROR(1/0)))}',
    'E1': '={\"DailyTarget\";ARRAYFORMULA(IF(LEN(C2:C), IFERROR(VLOOKUP(C2:C, Staffs!C:O, 13, FALSE), 40), IFERROR(1/0)))}',
    'F1': '={\"TotalSent\";MAP(A2:A, B2:B, LAMBDA(date_cell, sheet_name_cell, IF(ISBLANK(date_cell),, IFERROR(SUM(FILTER(INDIRECT(\"\'\"&sheet_name_cell&\"\'!P:P\"), INT(INDIRECT(\"\'\"&sheet_name_cell&\"\'!A:A\")) = INT(date_cell))), 0))))}',
    'G1': '={\"LeaveDays\";MAP(A2:A, B2:B, LAMBDA(date_cell, sheet_name_cell, IF(ISBLANK(date_cell),, IF((COUNTIFS(INDIRECT(\"\'\"&sheet_name_cell&\"\'!A:A\"), \">=\"&date_cell, INDIRECT(\"\'\"&sheet_name_cell&\"\'!A:A\"), \"<\"&date_cell+1, INDIRECT(\"\'\"&sheet_name_cell&\"\'!Q:Q\"), \">0\")) + (COUNTIFS(INDIRECT(\"\'\"&sheet_name_cell&\"\'!A:A\"), \">=\"&date_cell, INDIRECT(\"\'\"&sheet_name_cell&\"\'!A:A\"), \"<\"&date_cell+1, INDIRECT(\"\'\"&sheet_name_cell&\"\'!Q:Q\"), \"‡∏´‡∏¢‡∏∏‡∏î\")) > 0, \"üå¥ ‡∏•‡∏≤\", \"\"))))}',
    'H1': '={\"MissingDays\";ARRAYFORMULA(IF(LEN(A2:A), IF(G2:G <> \"\", \"\", IF(F2:F = 0, 1, \"\")), \"\"))}',
    'I1': '={\"MissingClips\";ARRAYFORMULA(IF(LEN(A2:A), IF(G2:G <> \"\", \"\", LET(missing, E2:E - F2:F, IF(missing > 0, missing, \"\"))), \"\"))}',
    'J1': '={\"Completion%\";ARRAYFORMULA(IF(LEN(A2:A), IFERROR(F2:F/E2:E), \"\"))}',
    'K1': '={\"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\";ARRAYFORMULA(IF(LEN(A2:A), IFS(G2:G <> \"\", \"üå¥ ‡∏•‡∏≤\", ISBLANK(F2:F), \"\", F2:F >= E2:E, \"‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏ö\", F2:F > 0, \"‚ö†Ô∏è ‡∏Ç‡∏≤‡∏î \" & (E2:E-F2:F) & \" ‡∏Ñ‡∏•‡∏¥‡∏õ\", F2:F = 0, \"üö´ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á\", TRUE, \"\"), \"\"))}'
  };

  // Loop to apply all formulas
  for (const cell in formulas) {
    sheet.getRange(cell).setFormula(formulas[cell]);
  }
  
  // Set number formats
  sheet.getRange("J:J").setNumberFormat("0.00%");
  sheet.getRange("E:I").setNumberFormat("0");
}


/**
 * ‚úÖ FINAL UNIFIED SCRIPT
 * Generates the monthly table structure and applies header formulas if it's a new sheet.
 */
function generateMonthlyTable() {
  const ui = SpreadsheetApp.getUi();
  const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  
  const summarySheet = spreadsheet.getSheetByName('Monthly_Summary') || spreadsheet.insertSheet('Monthly_Summary');
  const staffsSheet = spreadsheet.getSheetByName("Staffs");

  if (!staffsSheet) {
    ui.alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï‡∏ä‡∏∑‡πà‡∏≠ 'Staffs' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö");
    return;
  }

  const startDateInput = ui.prompt("üìÖ ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô 01/08/2025)", ui.ButtonSet.OK_CANCEL);
  if (startDateInput.getSelectedButton() !== ui.Button.OK || !startDateInput.getResponseText()) return;
  
  const parts = startDateInput.getResponseText().split("/");
  if (parts.length !== 3) {
    ui.alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (DD/MM/YYYY)");
    return;
  }
  
  SpreadsheetApp.getActiveSpreadsheet().toast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà", "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô");

  const startDate = new Date(Number(parts[2]), Number(parts[1]) - 1, Number(parts[0]));
  const year = startDate.getFullYear();
  const month = startDate.getMonth();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  const staffData = staffsSheet.getRange("F2:F" + staffsSheet.getLastRow()).getValues().flat().filter(String);
  const activeProjects = [...new Set(staffData)];

  const header = ['Date', 'SheetName', 'Name', 'Project'];
  const lastRow = summarySheet.getLastRow();
  let currentRow;

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏µ‡∏ï: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏µ‡∏ï‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ù‡∏±‡∏á‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  if (lastRow < 1) {
    summarySheet.getRange(1, 1, 1, 4).setValues([header]).setFontWeight("bold");
    setupHeaderFormulas(summarySheet); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ù‡∏±‡∏á‡∏™‡∏π‡∏ï‡∏£
    currentRow = 2;
  } else {
    currentRow = lastRow + 2;
  }

  const monthHeader = `‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${getMonthThai(month)} ${year + 543}`;
  summarySheet.getRange(currentRow, 1, 1, 11).merge().setValue(monthHeader).setBackground("#4a86e8").setFontColor("#ffffff").setFontWeight("bold").setHorizontalAlignment("center");
  currentRow++;

  const allRowsData = [];
  for (let d = 1; d <= daysInMonth; d++) {
    const day = new Date(year, month, d);
    allRowsData.push(Array(4).fill('')); // Daily separator, only for columns A-D
    for (const project of activeProjects) {
      allRowsData.push([day, project, '', '']); // ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏Ñ‡πà Date ‡πÅ‡∏•‡∏∞ SheetName
    }
  }

  if (allRowsData.length > 0) {
    const range = summarySheet.getRange(currentRow, 1, allRowsData.length, 4);
    range.setValues(allRowsData);
    
    // Style separators
    const fullRange = summarySheet.getRange(currentRow, 1, allRowsData.length, 11);
    const backgrounds = fullRange.getBackgrounds();
    for (let i = 0; i < allRowsData.length; i++) {
        if (allRowsData[i][0] === '') {
            for (let j = 0; j < 11; j++) {
                backgrounds[i][j] = "#d9d9d9";
            }
        }
    }
    fullRange.setBackgrounds(backgrounds);
  }
  
  SpreadsheetApp.getActiveSpreadsheet().toast("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô", 5);
}

function getMonthThai(monthIndex) {
  const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  return months[monthIndex];
}


/**
 * ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á UI (Sidebar) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 */
function showProjectPrompt() {
  var html = HtmlService.createHtmlOutputFromFile('ProjectInputUI')
      .setWidth(300)
      .setTitle('‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå');
  SpreadsheetApp.getUi().showSidebar(html);
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å UI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£
 * @param {string} projectName - ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Input ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 */
function applyFormulas(projectName) {
  if (!projectName || projectName.trim() === "") {
    SpreadsheetApp.getUi().alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå');
    return;
  }

  const sheet = SpreadsheetApp.getActiveSheet();
  const ui = SpreadsheetApp.getUi();

  try {
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)
    sheet.getRange("C1:D").clearContent();
    sheet.getRange("G1:H").clearContent();
    sheet.getRange("L1:M").clearContent();
    ui.alert('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà...');

    // ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    const formulas = {
      'C1': `={\"‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏à/‡∏ä‡πà‡∏≠‡∏á\"; \"\"; \"\"; MAP(A4:A, B4:B, LAMBDA(d, p, IF(ISBLANK(d),, IFERROR(FILTER(Transaction!K:K, Transaction!E:E = d, Transaction!D:D = \"${projectName} - Page \" & p)))))}`,
      'D1': `={\"‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏à\"; \"\"; \"\"; MAP(A4:A, B4:B, LAMBDA(d, p, IF(ISBLANK(d),, IFERROR(FILTER(Transaction!J:J, Transaction!E:E = d, Transaction!D:D = \"${projectName} - Page \" & p)))))}`,
      'G1': `={\"‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏•‡∏¥‡∏õ 1\"; \"\"; \"\"; MAP(A4:A, B4:B, LAMBDA(d, p, IF(ISBLANK(d),, IFERROR(FILTER(Transaction!F:F, Transaction!E:E = d, Transaction!D:D = \"${projectName} - Page \" & p)))))}`,
      'H1': `={\"‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ñ‡∏•‡∏¥‡∏õ 2\"; \"\"; \"\"; MAP(A4:A, B4:B, LAMBDA(d, p, IF(ISBLANK(d),, IFERROR(FILTER(Transaction!G:G, Transaction!E:E = d, Transaction!D:D = \"${projectName} - Page \" & p)))))}`,
      'L1': `={\"‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á 1\"; \"\"; \"\"; MAP(A4:A, B4:B, LAMBDA(d, p, IF(ISBLANK(d),, IFERROR(TEXT(TIMEVALUE(FILTER(Transaction!L:L, Transaction!E:E = d, Transaction!D:D = \"${projectName} - Page \" & p)), \"HH:MM\"), \"\"))))}`,
      'M1': `={\"‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á 2\"; \"\"; \"\"; MAP(A4:A, B4:B, LAMBDA(d, p, IF(ISBLANK(d),, IFERROR(TEXT(TIMEVALUE(FILTER(Transaction!L:L, Transaction!E:E = d, Transaction!D:D = \"${projectName} - Page \" & p)), \"HH:MM\"), \"\"))))}`
    };

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏ã‡∏•‡∏•‡πå
    for (const cell in formulas) {
      sheet.getRange(cell).setFormula(formulas[cell]);
    }

    ui.alert(`‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå "${projectName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!`);
  } catch (e) {
    ui.alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message);
  }
}

// ====================================================================
// ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Final Boss: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Conditional Formatting ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞
// - ‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏à‡∏∞‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏Å‡∏é" ‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏ä‡∏µ‡∏ï‡πÄ‡∏≠‡∏á
// ====================================================================

// --- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å ---
const HIGHLIGHT_COLOR = "#EAF1FC"; // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô Professional Look
const DATE_HEADER_KEYWORDS = ["date", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "submissiondate"]; 
const RULE_DESCRIPTION = "Gemini Auto-Highlight Rule"; // ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏é‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á

// =============================================================================
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" (‡πÉ‡∏ä‡πâ Logic ‡πÅ‡∏ö‡∏ö Hybrid ‡∏ó‡∏µ‡πà‡∏ä‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) ---
// =============================================================================
function installHighlightRulesOnAllSheets_Hybrid() {
  const ui = SpreadsheetApp.getUi();
  const allSheets = SpreadsheetApp.getActiveSpreadsheet().getSheets();
  let sheetsUpdatedCount = 0;
  
  ui.showSidebar(HtmlService.createHtmlOutput('<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏é‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>').setTitle('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'));

  allSheets.forEach(sheet => {
    if (applyConditionalFormattingLogic_Hybrid(sheet)) {
      sheetsUpdatedCount++;
    }
  });
  
  ui.alert('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!', `‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏é‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${sheetsUpdatedCount} ‡∏ä‡∏µ‡∏ï (‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ)`, ui.ButtonSet.OK);
}

// =======================================================================
// --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ä‡∏µ‡∏ï‡∏ô‡∏µ‡πâ" (‡πÉ‡∏ä‡πâ Logic ‡πÅ‡∏ö‡∏ö Simple ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß) ---
// =======================================================================
function runHighlightOnCurrentSheetOnly_Simple() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  if (applyConditionalFormattingLogic_Simple(sheet)) {
    SpreadsheetApp.getUi().alert(`‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï '${sheet.getName()}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
  } else {
    SpreadsheetApp.getUi().alert(`‡∏´‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï '${sheet.getName()}' ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö`);
  }
}

// ========================================================================
// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Logic ‡∏´‡∏•‡∏±‡∏Å (‡∏°‡∏µ 2 ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ) ---
// ========================================================================

/**
 * LOGIC ‡πÅ‡∏ö‡∏ö HYBRID (‡∏ä‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢): ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°
 */
function applyConditionalFormattingLogic_Hybrid(sheet) {
  const HIGHLIGHT_COLOR = "#EAF1FC";
  const DATE_HEADER_KEYWORDS = ["date", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "submissiondate"];

  let dateColumnIndex = -1, headerRowIndex = -1;
  try {
    const data = sheet.getRange(1, 1, 10, sheet.getLastColumn()).getValues();
    for (let i = 0; i < data.length; i++) { for (let j = 0; j < data[i].length; j++) { if (DATE_HEADER_KEYWORDS.includes(String(data[i][j]).toLowerCase().replace(/\s/g, ''))) { headerRowIndex = i + 1; dateColumnIndex = j + 1; break; } } if (headerRowIndex != -1) break; }
  } catch (e) { return false; }

  if (dateColumnIndex === -1) return false;

  const firstDataRow = headerRowIndex + 1;
  const columnLetter = sheet.getRange(1, dateColumnIndex).getA1Notation().replace("1", "");
  // ‚úÖ‚úÖ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏é‡∏´‡∏≤‡∏¢: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Range ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚úÖ‚úÖ‚úÖ
  const rangeA1Notation = `${columnLetter}${firstDataRow}:${columnLetter}`;
  const expectedFormula = `=$${columnLetter}${firstDataRow}=TODAY()`;

  const rules = sheet.getConditionalFormatRules();

  for (const rule of rules) {
    const criteria = rule.getBooleanCondition();
    if (criteria && criteria.getCriteriaType() === SpreadsheetApp.BooleanCriteria.CUSTOM_FORMULA) {
      if (criteria.getCriteriaValues()[0] === expectedFormula) {
         Logger.log(`‡∏ä‡∏µ‡∏ï '${sheet.getName()}' ‡∏°‡∏µ‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß -> ‡∏Ç‡πâ‡∏≤‡∏°`);
         return false;
      }
    }
  }
  
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Å‡∏é‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏•‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
  return applyFormattingRule(sheet, rules, dateColumnIndex, headerRowIndex, HIGHLIGHT_COLOR);
}


/**
 * LOGIC ‡πÅ‡∏ö‡∏ö SIMPLE (‡πÄ‡∏£‡πá‡∏ß): ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏™‡∏°‡∏≠
 */
function applyConditionalFormattingLogic_Simple(sheet) {
   const HIGHLIGHT_COLOR = "#EAF1FC";
   return applyFormattingRule(sheet, sheet.getConditionalFormatRules(), null, null, HIGHLIGHT_COLOR);
}


/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏é‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
 */
function applyFormattingRule(sheet, rules, dateColumnIndex, headerRowIndex, highlightColor) {
  const DATE_HEADER_KEYWORDS = ["date", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", "submissiondate"];

  if (!dateColumnIndex || !headerRowIndex) {
      try {
        const data = sheet.getRange(1, 1, 10, sheet.getLastColumn()).getValues();
        for (let i = 0; i < data.length; i++) { for (let j = 0; j < data[i].length; j++) { if (DATE_HEADER_KEYWORDS.includes(String(data[i][j]).toLowerCase().replace(/\s/g, ''))) { headerRowIndex = i + 1; dateColumnIndex = j + 1; break; } } if (headerRowIndex != -1) break; }
      } catch (e) { return false; }
  }

  if (dateColumnIndex === -1) return false;

  const newRules = rules.filter(rule => {
    const criteria = rule.getBooleanCondition();
    return !(criteria && criteria.getCriteriaType() === SpreadsheetApp.BooleanCriteria.CUSTOM_FORMULA && criteria.getCriteriaValues()[0].includes("=TODAY()"));
  });

  const firstDataRow = headerRowIndex + 1;
  const columnLetter = sheet.getRange(1, dateColumnIndex).getA1Notation().replace("1", "");
  // ‚úÖ‚úÖ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏é‡∏´‡∏≤‡∏¢: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Range ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚úÖ‚úÖ‚úÖ
  const rangeToApply = sheet.getRange(`${columnLetter}${firstDataRow}:${columnLetter}`);
  
  const newRule = SpreadsheetApp.newConditionalFormatRule()
    .setRanges([rangeToApply])
    .whenFormulaSatisfied(`=$${columnLetter}${firstDataRow}=TODAY()`)
    .setBackground(highlightColor)
    .build();

  newRules.push(newRule);
  sheet.setConditionalFormatRules(newRules);
  
  Logger.log(`‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Å‡∏é‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï '${sheet.getName()}' ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
  return true;
}





